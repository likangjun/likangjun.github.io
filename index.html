<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Likangjun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="06XSvFZPQvqk10xzDhYBgeDo01CUCCASMBEfjflgsc4">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Likangjun">
<meta property="og:url" content="http://likangjun.com/index.html">
<meta property="og:site_name" content="Likangjun">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Likangjun">
<meta name="twitter:description">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Likangjun</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/atom.xml">Rss</a>
        
          <a class="main-nav-link" href="/sitemap.xml">Sitemap</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://likangjun.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Redis-消息队列和异步处理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/05/Redis-消息队列和异步处理/" class="article-date">
  <time datetime="2016-12-05T13:39:37.000Z" itemprop="datePublished">2016-12-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/05/Redis-消息队列和异步处理/">Redis-消息队列和异步处理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前公司有个app的项目，里面有即时聊天，需要一个存放聊天记录的接口</p>
<p>每一条聊天记录都直接存放mysql，来一条insert一条，量不大还好说，基本都能应付。但是如果量特别大，一天几百万条，上千万条，这个insert操作就会执行几百万次，会不会响应不过来？用户体验会不会降低？</p>
<p>类似的案例还有</p>
<p>一个帖子，用户每访问一次就要<code>set visitor = visitor+1</code>，每天访问上百万次，就要update上百万次，，这个聊天记录表又是访问请求最高的，会不会锁死？</p>
<p>其实这些都可以优化</p>
<p>Redis读的速度是110000次/s,写的速度是81000次/s 。</p>
<p>第一个案例里面可以用Redis做消息中转站，用一个list存放我们的聊天记录。</p>
<p>利用Redis的性能，我们可以把这些请求都写到缓存。然后后台启用一个crontab定时任务，每分钟执行，把队列里的数据拿出来，存到MySQL，甚至可以每10秒，5秒做一次操作</p>
<p>这里给大家一个简单的demo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//插入消息队列</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionPush</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	$key = <span class="string">'chatLog:'</span> . date(<span class="string">"Ymd"</span>);</span><br><span class="line">    $content = <span class="string">'测试内容'</span>;</span><br><span class="line">    $data = [</span><br><span class="line">        <span class="string">'user_id'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">'create_time'</span> =&gt; date(<span class="string">"Y-m-d H:i:s"</span>),</span><br><span class="line">        <span class="string">'content'</span> =&gt; $content</span><br><span class="line">    ];</span><br><span class="line">    RedCache::rPush($key, json_encode($data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pop插入数据库</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionPop</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	$key = <span class="string">'chatLog:'</span> . date(<span class="string">"Ymd"</span>);</span><br><span class="line">    $length = RedCache::lLen($key);</span><br><span class="line">    <span class="keyword">if</span> ($length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">            $data = RedCache::lPop($key);</span><br><span class="line">            TestService::insertChat(json_decode($data, <span class="keyword">true</span>));</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用linux的crontab定时任务异步的去调用<code>actionPop</code></p>
<p>因为crontab的最快频率是1分钟调用一次，如果实时性要求很高，比如2秒</p>
<p>可以写个脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">step=2 <span class="comment">#间隔</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (( i = 0; i &lt; 60; i=(i+step) )); <span class="keyword">do</span></span><br><span class="line">    $(curl http://127.0.0.1/kxds/web/index.php?r=redis/list/<span class="built_in">test</span>2)</span><br><span class="line">    sleep <span class="variable">$step</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
<p>然后创建crontab任务</p>
<p>每分钟去执行这个脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /web/chat.sh</span><br></pre></td></tr></table></figure>
<p>这样就实现了每2秒钟去掉我们的pop-insert接口</p>
<p>利用Apache的ab做测试<br>1000次请求100个并发结果：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">erver Software:         nginx/1.8.1</span><br><span class="line">Server Hostname:        127.0.0.1</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /kxds/web/index.php?r=redis/list/test1</span><br><span class="line">Document Length:        0 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken for tests:   9.936 seconds</span><br><span class="line">Complete requests:      1000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      357000 bytes</span><br><span class="line">HTML transferred:       0 bytes</span><br><span class="line">Requests per second:    100.65 [#/sec] (mean)</span><br><span class="line">Time per request:       993.563 [ms] (mean)</span><br><span class="line">Time per request:       9.936 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          35.09 [Kbytes/sec] received</span><br></pre></td></tr></table></figure></p>
<p>可以看到结果接近10秒钟</p>
<p>而直接接受消息同步存入mysql的测试结果是13.288 seconds</p>
<p>这个响应时间相差还是比较大的</p>
<p>不过这里注意的是，异步更新的内容，属于“丢了其实关系也不大”的数据，如果是非常核心的数据，异步更新要注意数据丢失的危险</p>
<p>第二个案例类似的还有很多</p>
<p>这个数据，其实实时性需要不是那么高，不是每个请求都必须立即处理</p>
<p>这里可以用一个Redis的hash来存放，帖子id对应访问量，每次请求的时候把帖子id对应的值incr增1</p>
<p>同样异步的定时的去从hash里读取数据，update数据库</p>
<p>这样就做到了请求合并和异步更新，可能每次去更新的时候都有几十次上百次增量，这样就合并吊了几十次上百次请求</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/12/05/Redis-消息队列和异步处理/" data-id="ciwc4lj530001go7zbpbsjz0l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发/">并发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Redis用法和总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/25/Redis用法和总结/" class="article-date">
  <time datetime="2016-11-24T16:19:01.000Z" itemprop="datePublished">2016-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/25/Redis用法和总结/">Redis用法和总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="什么是Redis"><a href="#什么是Redis" class="headerlink" title="什么是Redis"></a>什么是Redis</h3><p>MySQL：关系型数据库</p>
<p>NoSQL：非关系型的数据库，数据之间无关系，无需事先为要存储的数据建立字段，随时可以存储自定义的数据格式，有非常高的读写性能，尤其在大数据量下，表现非常优秀。</p>
<ul>
<li>键值(Key-Value)存储数据库(Redis)</li>
<li>列存储数据库</li>
<li>文档型数据库(MongoDb)</li>
<li>图形(Graph)数据库</li>
</ul>
<p>Redis 就是一个 Key-Value 存储系统。支持的数据类型包括string(字符串)、hash(哈希)、list(链表)、set(集合)和zset(有序集合)等等。</p>
<h4 id="Redis的性能"><a href="#Redis的性能" class="headerlink" title="Redis的性能"></a>Redis的性能</h4><p>官方的bench-mark数据：<br>测试完成了50个并发执行100000个请求。<br>设置和获取的值是一个256字节字符串。<br>结果:读的速度是110000次/s,写的速度是81000次/s 。</p>
<h4 id="Redis的持久化"><a href="#Redis的持久化" class="headerlink" title="Redis的持久化"></a>Redis的持久化</h4><p>Redis运行在内存中但是可以持久化到磁盘</p>
<p>Redis提供了多种不同级别的持久化方式:一种是RDB,另一种是AOF.</p>
<p>RDB 持久化可以在指定的时间间隔内生成数据集的时间点快照。当redis需要做持久化时，redis会fork一个子进程；子进程读出数据并将数据写到磁盘上一个临时RDB文件中；当子进程完成写临时文件后，将原来的RDB替换掉，这样的好处就是可以copy-on-write，缺点就是在redis异常死掉时， 最近的数据会丢失</p>
<p>AOF redis每执行一个修改数据的命令，都会把它添加到aof文件中，当redis重启时，将会读取AOF文件进行“重放”以恢复到redis关闭前的最后时刻。</p>
<p>Redis 可以同时使用 AOF 持久化和 RDB 持久化。 在这种情况下， 当 Redis 重启时， 它会优先使用 AOF 文件来还原数据集， 因为 AOF 文件保存的数据集通常比 RDB 文件所保存的数据集更完整</p>
<h3 id="Redis为什么这么快"><a href="#Redis为什么这么快" class="headerlink" title="Redis为什么这么快"></a>Redis为什么这么快</h3><p>1）绝大部分请求是纯粹的内存操作（非常快速）<br>2）采用单线程,避免了不必要的线程切换开销<br>3）非阻塞IO </p>
<h3 id="Redis用法"><a href="#Redis用法" class="headerlink" title="Redis用法"></a>Redis用法</h3><p>redis中文网：<a href="http://www.redis.net.cn/" target="_blank" rel="external">http://www.redis.net.cn/</a><br>php-redis文档：<a href="http://www.cnblogs.com/weafer/archive/2011/09/21/2184059.html" target="_blank" rel="external">http://www.cnblogs.com/weafer/archive/2011/09/21/2184059.html</a></p>
<blockquote>
<h3 id="string-字符串"><a href="#string-字符串" class="headerlink" title="string(字符串)"></a><strong><code>string(字符串)</code></strong></h3></blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> lkj likangjun</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get lkj</span><br><span class="line"><span class="string">"likangjun"</span></span><br><span class="line"><span class="comment">#返回 key 中字符串值的子字符</span></span><br><span class="line">127.0.0.1:6379&gt; getrange lkj 0 1</span><br><span class="line"><span class="string">"li"</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> redis phpredis</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget lkj redis</span><br><span class="line">1) <span class="string">"likangjun"</span></span><br><span class="line">2) <span class="string">"phpredis"</span></span><br><span class="line"><span class="comment">#设定过期时间</span></span><br><span class="line">127.0.0.1:6379&gt; setex xb 5 xbzh</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ttl xb</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line"><span class="comment">#只有在 key 不存在时设置 key 的值</span></span><br><span class="line">127.0.0.1:6379&gt; setnx lkj abcde</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setnx kxds kaixindaishu</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; append lkj again</span><br><span class="line">(<span class="built_in">integer</span>) 14</span><br><span class="line">127.0.0.1:6379&gt; get lkj</span><br><span class="line"><span class="string">"likangjunagain"</span></span><br><span class="line">127.0.0.1:6379&gt; incr number</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; incr number</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; incrby number 100</span><br><span class="line">(<span class="built_in">integer</span>) 102</span><br></pre></td></tr></table></figure>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>1.数据缓存<br>2.原子计数器（原子性，可用于抢购，秒杀 ）</p>
<blockquote>
<h3 id="hash-哈希"><a href="#hash-哈希" class="headerlink" title="hash(哈希)"></a><strong><code>hash(哈希)</code></strong></h3></blockquote>
<p>Redis 中每个 hash 可以存储 (2^32-1) 键值对（40多亿）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hmset user_info_7 id 7 name likangjun mobile 18672792276</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hget user_info_7 id</span><br><span class="line"><span class="string">"7"</span></span><br><span class="line">127.0.0.1:6379&gt; HGETALL user_info_7</span><br><span class="line">1) <span class="string">"id"</span></span><br><span class="line">2) <span class="string">"7"</span></span><br><span class="line">3) <span class="string">"name"</span></span><br><span class="line">4) <span class="string">"likangjun"</span></span><br><span class="line">5) <span class="string">"mobile"</span></span><br><span class="line">6) <span class="string">"18672792276"</span></span><br><span class="line">127.0.0.1:6379&gt; HKEYS user_info_7</span><br><span class="line">1) <span class="string">"id"</span></span><br><span class="line">2) <span class="string">"name"</span></span><br><span class="line">3) <span class="string">"mobile"</span></span><br><span class="line">127.0.0.1:6379&gt; HVALS user_info_7</span><br><span class="line">1) <span class="string">"7"</span></span><br><span class="line">2) <span class="string">"likangjun"</span></span><br><span class="line">3) <span class="string">"18672792276"</span></span><br><span class="line">127.0.0.1:6379&gt; HEXISTS user_info_7 <span class="built_in">times</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; HSETNX user_info_7 <span class="built_in">times</span> 1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; HINCRBY user_info_7 <span class="built_in">times</span> 1</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure></p>
<h3 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h3><p>1.用户信息</p>
<blockquote>
<h3 id="list-列表"><a href="#list-列表" class="headerlink" title="list(列表)"></a><strong><code>list(列表)</code></strong></h3></blockquote>
<p>Redis列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素导列表的头部（左边）或者尾部（右边）</p>
<p>一个列表最多可以包含 (2^32-1) 个元素(每个列表超过40亿个元素)。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush list1 a</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush list1 b</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush list1 c</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list1 0 -1</span><br><span class="line">1) <span class="string">"a"</span></span><br><span class="line">2) <span class="string">"b"</span></span><br><span class="line">3) <span class="string">"c"</span></span><br><span class="line">127.0.0.1:6379&gt; rpop list1</span><br><span class="line"><span class="string">"c"</span></span><br><span class="line">127.0.0.1:6379&gt; lpop list1</span><br><span class="line"><span class="string">"a"</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list1 0 -1</span><br><span class="line">1) <span class="string">"b"</span></span><br><span class="line">127.0.0.1:6379&gt; rpush list2 a</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush list2 b</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush list2 c</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpoplpush list2 list1</span><br><span class="line"><span class="string">"c"</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list1 0 -1</span><br><span class="line">1) <span class="string">"c"</span></span><br><span class="line">2) <span class="string">"b"</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list2 0 -1</span><br><span class="line">1) <span class="string">"a"</span></span><br><span class="line">2) <span class="string">"b"</span></span><br><span class="line">127.0.0.1:6379&gt; linsert list2 before b d</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list2 0 -1</span><br><span class="line">1) <span class="string">"a"</span></span><br><span class="line">2) <span class="string">"d"</span></span><br><span class="line">3) <span class="string">"b"</span></span><br><span class="line">127.0.0.1:6379&gt; lpush list3 a</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush list3 b</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush list3 c</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">"c"</span></span><br><span class="line">2) <span class="string">"b"</span></span><br><span class="line">3) <span class="string">"a"</span></span><br><span class="line">127.0.0.1:6379&gt; lpop list3</span><br><span class="line"><span class="string">"c"</span></span><br><span class="line">127.0.0.1:6379&gt; rpop list3</span><br><span class="line"><span class="string">"a"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h3><p>1.消息队列</p>
<blockquote>
<h3 id="set-集合"><a href="#set-集合" class="headerlink" title="set(集合)"></a><strong><code>set(集合)</code></strong></h3></blockquote>
<p>Redis的Set是string类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。</p>
<p>Redis 中 集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)。</p>
<p>集合中最大的成员数为(2^32-1) (每个集合可存储40多亿个成员)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd lkj-code nginx</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd lkj-code php</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd lkj-code mysql</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd lkj-code html</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd abc-code css</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd abc-code html</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS lkj-code</span><br><span class="line">1) <span class="string">"mysql"</span></span><br><span class="line">2) <span class="string">"php"</span></span><br><span class="line">3) <span class="string">"html"</span></span><br><span class="line">4) <span class="string">"nginx"</span></span><br><span class="line">127.0.0.1:6379&gt; sinter lkj-code abc-code</span><br><span class="line">1) <span class="string">"html"</span></span><br><span class="line">127.0.0.1:6379&gt; sinterstore common-code  lkj-code abc-code</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS common-code</span><br><span class="line">1) <span class="string">"html"</span></span><br><span class="line">127.0.0.1:6379&gt; sdiff lkj-code common-code</span><br><span class="line">1) <span class="string">"php"</span></span><br><span class="line">2) <span class="string">"mysql"</span></span><br><span class="line">3) <span class="string">"nginx"</span></span><br><span class="line">127.0.0.1:6379&gt; sunion lkj-code abc-code</span><br><span class="line">1) <span class="string">"html"</span></span><br><span class="line">2) <span class="string">"nginx"</span></span><br><span class="line">3) <span class="string">"css"</span></span><br><span class="line">4) <span class="string">"mysql"</span></span><br><span class="line">5) <span class="string">"php"</span></span><br><span class="line">127.0.0.1:6379&gt; sadd lkj-code html</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER lkj-code</span><br><span class="line"><span class="string">"nginx"</span></span><br><span class="line">127.0.0.1:6379&gt; SPOP lkj-code</span><br><span class="line"><span class="string">"html"</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS lkj-code</span><br><span class="line">1) <span class="string">"nginx"</span></span><br><span class="line">2) <span class="string">"php"</span></span><br><span class="line">3) <span class="string">"mysql"</span></span><br><span class="line">127.0.0.1:6379&gt; srem lkj-code mysql</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>
<h3 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h3><p>1.共同好友<br>2.利用唯一性，可以统计访问网站的所有独立 IP<br>3.好友推荐的时候，根据 tag 求交集，大于多少个就可以推荐</p>
<blockquote>
<h3 id="zset-有序集合"><a href="#zset-有序集合" class="headerlink" title="zset(有序集合)"></a><strong><code>zset(有序集合)</code></strong></h3></blockquote>
<p>Redis 有序集合和集合一样也是string类型元素的集合,且不允许重复的成员。</p>
<p>不同的是每个元素都会关联一个double类型的分数。redis正是通过分数来为集合中的成员进行从小到大的排序。</p>
<p>有序集合的成员是唯一的,但分数(score)却可以重复。</p>
<p>集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)。 集合中最大的成员数为 (2^32-1) (每个集合可存储40多亿个成员)。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd rank1 10 php</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd rank1 2 ios</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd rank1 8 java</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; ZINCRBY rank1 1 ios</span><br><span class="line"><span class="string">"3"</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGE rank1 0 -1 withscores</span><br><span class="line">1) <span class="string">"ios"</span></span><br><span class="line">2) <span class="string">"3"</span></span><br><span class="line">3) <span class="string">"java"</span></span><br><span class="line">4) <span class="string">"8"</span></span><br><span class="line">5) <span class="string">"php"</span></span><br><span class="line">6) <span class="string">"10"</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrange rank1 0 -1 withscores</span><br><span class="line">1) <span class="string">"php"</span></span><br><span class="line">2) <span class="string">"10"</span></span><br><span class="line">3) <span class="string">"java"</span></span><br><span class="line">4) <span class="string">"8"</span></span><br><span class="line">5) <span class="string">"ios"</span></span><br><span class="line">6) <span class="string">"3"</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrange rank1 0 -1</span><br><span class="line">1) <span class="string">"php"</span></span><br><span class="line">2) <span class="string">"java"</span></span><br><span class="line">3) <span class="string">"ios"</span></span><br><span class="line">127.0.0.1:6379&gt; zscore rank1 php</span><br><span class="line"><span class="string">"10"</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrank rank1 php</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; zadd rank2 99 php</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd rank2 10 ios</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd rank2 50 java</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrevrange rank1 0 -1 withscores</span><br><span class="line">1) <span class="string">"php"</span></span><br><span class="line">2) <span class="string">"10"</span></span><br><span class="line">3) <span class="string">"java"</span></span><br><span class="line">4) <span class="string">"8"</span></span><br><span class="line">5) <span class="string">"ios"</span></span><br><span class="line">6) <span class="string">"3"</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrange rank2 0 -1 withscores</span><br><span class="line">1) <span class="string">"php"</span></span><br><span class="line">2) <span class="string">"99"</span></span><br><span class="line">3) <span class="string">"java"</span></span><br><span class="line">4) <span class="string">"50"</span></span><br><span class="line">5) <span class="string">"ios"</span></span><br><span class="line">6) <span class="string">"10"</span></span><br><span class="line"><span class="comment">#计算给定的一个或多个有序集的并集</span></span><br><span class="line">127.0.0.1:6379&gt; ZUNIONSTORE rank 2 rank1 rank2 WEIGHTS  2 1</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zrevrange rank 0 -1 withscores</span><br><span class="line">1) <span class="string">"php"</span></span><br><span class="line">2) <span class="string">"119"</span></span><br><span class="line">3) <span class="string">"java"</span></span><br><span class="line">4) <span class="string">"66"</span></span><br><span class="line">5) <span class="string">"ios"</span></span><br><span class="line">6) <span class="string">"16"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="应用场景-4"><a href="#应用场景-4" class="headerlink" title="应用场景"></a>应用场景</h3><p>1.带有权重的元素，比如投票排行榜</p>
<blockquote>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a><strong><code>事务</code></strong></h3></blockquote>
<p>Redis 事务可以一次执行多个命令， 并且带有以下两个重要的保证：</p>
<p>事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</p>
<p>事务是一个原子操作：事务中的命令要么全部被执行，要么全部都不执行。<br>一个事务从开始到执行会经历以下三个阶段：</p>
<p>开始事务。<br>命令入队。<br>执行事务。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> book likangjun</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get book</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; ZINCRBY rank 1 php</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; zrevrange rank1 0 -1 withscores</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) <span class="string">"likangjun"</span></span><br><span class="line">3) <span class="string">"120"</span></span><br><span class="line">4) 1) <span class="string">"php"</span></span><br><span class="line">   2) <span class="string">"11"</span></span><br><span class="line">   3) <span class="string">"java"</span></span><br><span class="line">   4) <span class="string">"8"</span></span><br><span class="line">   5) <span class="string">"ios"</span></span><br><span class="line">   6) <span class="string">"3"</span></span><br><span class="line">   7) <span class="string">"html"</span></span><br><span class="line">   8) <span class="string">"1"</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<h3 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a><strong><code>发布订阅</code></strong></h3></blockquote>
<p>Redis 发布订阅(pub/sub)是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息。</p>
<blockquote>
<h3 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a><strong><code>HyperLogLog</code></strong></h3></blockquote>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFADD code <span class="string">"redis"</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD code <span class="string">"php"</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD code <span class="string">"java"</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT w3ckey</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure>
<h3 id="主从同步"><a href="#主从同步" class="headerlink" title="主从同步"></a>主从同步</h3><p>主从同步可以防止主机坏掉导致网站不能正常运作，这种方法即把从机设置成主机即可</p>
<p>Redis主从同步设置很简单，设置到Slave服务器后，Slave自动和Master建立连接</p>
<p>第一阶段<br>1.Slave服务器主动连接到Master服务器<br>2.Slave服务器发送SYCN命令到Master服务器请求同步<br>3.Master服务器备份数据到rdb文件<br>4.Master服务器把rdb文件传输到Slave服务器<br>5.Slave服务器清空数据库数据，把rdb文件数据导入到数据库<br>第二阶段<br>Master服务器把用户所有更改数据的操作，通过命令转发给所有的Slave服务器，Slave服务器只需要执行Master服务器发送过来的命令就可以达到同步的效果</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Redis远远不只是缓存这么简单，缓存只是其中的一个小部分<br>Redis更多的在于其丰富的数据结构和灵活性，可以使很多功能实现起来更加简单有效，极大的提高效率和性能</p>
<p>Redis数据库在以下的这几种情况下比较适用：<br>1、数据模型比较简单；<br>2、需要灵活性更强的IT系统；<br>3、对数据库性能要求较高；<br>4、不需要高度的数据一致性；<br>5、对于给定key，比较容易映射复杂值的环境。</p>
<p>注：O(1)指的是常数时间运行，比如操作对象为一个链表，对其有一个算法，O(1)时间指的是，无论链表大或者小，所耗费的时间都是一样的;<br>O(n)指的是某算法的运行时间与输入规模成正比，即，若输入规模为T,花费时间为N,则输入规模2T时花费时间为2N</p>
<p>Copy-on-Write简称COW，基本的原理是：<br>当我要修改数据块A的内容的时候，我先把A读出来，写到B块里，如果写的过程掉电了，原来A的内容还在，如果是还写到原来的位置上，那么写入的数据究竟写了多少就不确定了，会不会破坏原来的数据也不好说。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/25/Redis用法和总结/" data-id="ciwc4lj5b0004go7zza7pdp8i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-mysql行级锁处理小规模并发实现抢购秒杀" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/17/mysql行级锁处理小规模并发实现抢购秒杀/" class="article-date">
  <time datetime="2016-11-17T14:17:03.000Z" itemprop="datePublished">2016-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/17/mysql行级锁处理小规模并发实现抢购秒杀/">mysql行级锁处理小规模并发实现抢购秒杀</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>MySQL的锁机制比较简单，其最显著的特点是不同的存储引擎支持不同的锁机制。比如，MyISAM和MEMORY存储引擎采用的是表级锁（table-level locking）；BDB存储引擎采用的是页面锁（page-level locking），但也支持表级锁；InnoDB存储引擎既支持行级锁（row-level locking），也支持表级锁，但默认情况下是采用行级锁。</p>
<p>1<code>表级锁</code>：直接锁定整张表，在你锁定期间，其它进程无法对该表进行写操作。如果你是写锁，则其它进程则读也不允许<br>2<code>行级锁</code>：仅对指定的记录进行加锁，这样其它进程还是可以对同一个表中的其它记录进行操作。<br>3<code>页面锁</code>：表级锁速度快，但冲突多，行级冲突少，但速度慢。所以取了折衷的页级，一次锁定相邻的一组记录。</p>
<p>场景：现在最后只有1件库存，同时有100个或1000个请求，如何能保证只有一个用户能够抢到最后这件商品呢</p>
<h4 id="不做并发处理的简单示范"><a href="#不做并发处理的简单示范" class="headerlink" title="不做并发处理的简单示范"></a>不做并发处理的简单示范</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionTest</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $data = TestService::get();</span><br><span class="line">    $number = $data[<span class="string">'number'</span>];</span><br><span class="line">    <span class="comment">//还有库存</span></span><br><span class="line">    <span class="keyword">if</span> ($number &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//库存减1</span></span><br><span class="line">        $result = TestService::update($data[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">	    <span class="comment">//插入订单</span></span><br><span class="line">            TestService::insert();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>update()</code>执行的sql语句是<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> goods <span class="keyword">set</span> <span class="built_in">number</span> = <span class="built_in">number</span><span class="number">-1</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'1'</span>;</span><br></pre></td></tr></table></figure></p>
<p>用ab做压力测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ab -n1000 -c100 <span class="string">"http://127.0.0.1/xxxxxxxx/test"</span></span><br></pre></td></tr></table></figure></p>
<p><code>100</code>个用户<code>1000</code>个请求<br>测试完看数据库，发现number变成了<code>-3</code>，订单表里面出现了<code>4</code>个订单<br>出现这个结果是在我们意料之中的，并发越大，订单数也越多，超卖的也越多</p>
<p>同样的方法，我们只改一下<code>sql</code>再做测试</p>
<h4 id="利用mysql行级锁"><a href="#利用mysql行级锁" class="headerlink" title="利用mysql行级锁"></a>利用mysql行级锁</h4><p>将<code>update()</code>的sql语句改为<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> goods <span class="keyword">set</span> <span class="built_in">number</span> = <span class="built_in">number</span><span class="number">-1</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'1'</span> <span class="keyword">and</span> <span class="built_in">number</span> &gt; <span class="string">'0'</span>;</span><br></pre></td></tr></table></figure></p>
<p>再用ab测试</p>
<h5 id="会发现number为0，订单表也只有1个订单"><a href="#会发现number为0，订单表也只有1个订单" class="headerlink" title="会发现number为0，订单表也只有1个订单"></a>会发现number为0，订单表也只有1个订单</h5><p>甚至1000个用户10000个请求测试，依然如此</p>
<p>分析下发现，当条件加上<code>number &gt; &#39;0&#39;</code>后，假如有3个并发，同时执行这条sql<br>第一个执行的时候，mysql的行级锁会将此条记录加锁，当这个执行完以后，number已被更新为0</p>
<p>此时锁打开，第二个第三个执行的时候，where条件<code>number &gt; &#39;0&#39;</code>无法满足，所以后面的请求将无法再去更新number和下单</p>
<p>而之前不加这个<code>number &gt; &#39;0&#39;</code>这个条件的话，有锁和没锁是无所谓的，都会执行，并且完成update</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/17/mysql行级锁处理小规模并发实现抢购秒杀/" data-id="ciwc4lj5f0008go7zgnq6df9k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发/">并发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-php 关于支付宝手机网站支付" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/15/php 关于支付宝手机网站支付/" class="article-date">
  <time datetime="2016-11-15T06:46:15.000Z" itemprop="datePublished">2016-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/15/php 关于支付宝手机网站支付/">php 关于支付宝手机网站支付(alipay.wap.create.direct.pay.by.user)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://doc.open.alipay.com/doc2/detail?treeId=60&amp;articleId=103564&amp;docType=1" target="_blank" rel="external">官方文档</a><br><a href="http://aopsdkdownload.cn-hangzhou.alipay-pub.aliyun-inc.com/demo/alipaywapdirect.zip?spm=a219a.7629140.0.0.QiNZUG&amp;file=alipaywapdirect.zip" target="_blank" rel="external">官方demo</a></p>
<p>手机网站支付的文档和demo给的已经特别的详细了， 这里我就说一下实际开发中值得注意的问题吧</p>
<h4 id="1-支付宝手机网站支付，需要去支付宝的后台的签约管理添加手机支付"><a href="#1-支付宝手机网站支付，需要去支付宝的后台的签约管理添加手机支付" class="headerlink" title="1.支付宝手机网站支付，需要去支付宝的后台的签约管理添加手机支付"></a>1.支付宝手机网站支付，需要去支付宝的后台的签约管理添加手机支付</h4><p><img src="http://i1.piimg.com/567571/b79917bf703682f6.png" alt=""></p>
<h4 id="2-构造要请求的参数数组的时候加上-quot-app-pay-quot-gt-quot-Y-quot"><a href="#2-构造要请求的参数数组的时候加上-quot-app-pay-quot-gt-quot-Y-quot" class="headerlink" title="2.构造要请求的参数数组的时候加上&quot;app_pay&quot; =&gt; &quot;Y&quot;"></a>2.构造要请求的参数数组的时候加上<code>&quot;app_pay&quot; =&gt; &quot;Y&quot;</code></h4><p>在浏览器调用的时候可以唤起支付宝客户端，如果没有安装支付宝，则继续进行手机网站支付</p>
<h4 id="3-页面跳转同步通知return-url如果你想带其他参数也是可以的"><a href="#3-页面跳转同步通知return-url如果你想带其他参数也是可以的" class="headerlink" title="3.页面跳转同步通知return_url如果你想带其他参数也是可以的"></a>3.页面跳转同步通知<code>return_url</code>如果你想带其他参数也是可以的</h4><p>文档上是这么写的</p>
<p>设置页面跳转同步通知页面（return_url）的路径时，不要在页面文件的后面再加上自定义参数。例如：<br>错误的写法：<a href="http://www.alipay.com/alipay/return_url.php?xx=11" target="_blank" rel="external">http://www.alipay.com/alipay/return_url.php?xx=11</a><br>正确的写法：<a href="http://www.alipay.com/alipay/return_url.php" target="_blank" rel="external">http://www.alipay.com/alipay/return_url.php</a></p>
<p>文档这么写是因为<code>return_url</code>在验证的时候会通过<code>$_GET</code>去生成签名，这个签名会和通过<code>notify_id</code>获取到的结果做比对，所以这里<code>$_GET</code>里面不能有别的参数</p>
<h4 id="但事实上可以通过代码来避开"><a href="#但事实上可以通过代码来避开" class="headerlink" title="但事实上可以通过代码来避开"></a>但事实上可以通过代码来避开</h4><p>比如你的return_url 为 <a href="http://xxxxxx/alipay/return_url.php?uuid=12345" target="_blank" rel="external">http://xxxxxx/alipay/return_url.php?uuid=12345</a></p>
<p>那么在你的return_url.php就得改成<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$get_temp = $_GET;</span><br><span class="line"><span class="keyword">unset</span>($_GET[<span class="string">'uuid'</span>]);</span><br><span class="line"><span class="comment">//这个时候的$_GET是不带我们附加的参数的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//$alipay_config 配置文件参数</span></span><br><span class="line">$alipayNotify = <span class="keyword">new</span> \AlipayNotify($alipay_config);</span><br><span class="line">$verify_result = $alipayNotify-&gt;verifyReturn();</span><br><span class="line"></span><br><span class="line">$_GET = $get_temp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个时候就可以开始我们的逻辑了</span></span><br><span class="line">$uuid = $_GET[<span class="string">'uuid'</span>];</span><br><span class="line"><span class="keyword">if</span> ($verify_result) &#123;<span class="comment">//验证成功</span></span><br><span class="line">    <span class="comment">//交易状态</span></span><br><span class="line">    $trade_status = $_GET[<span class="string">'trade_status'</span>];</span><br><span class="line">    <span class="keyword">if</span> ($trade_status == <span class="string">'TRADE_FINISHED'</span> || $trade_status == <span class="string">'TRADE_SUCCESS'</span>) &#123;</span><br><span class="line">        <span class="comment">//交易成功       </span></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"trade_status="</span> . $_GET[<span class="string">'trade_status'</span>];</span><br><span class="line">     &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"验证失败"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/15/php 关于支付宝手机网站支付/" data-id="ciwc4lj5c0006go7znb9ht819" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/支付/">支付</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-php 递归函数的应用(三) 层级结构数据的树状输出" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/15/php 递归函数的应用(三) 层级结构数据的树状输出/" class="article-date">
  <time datetime="2016-11-15T02:48:35.000Z" itemprop="datePublished">2016-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/15/php 递归函数的应用(三) 层级结构数据的树状输出/">PHP 递归函数的应用(三)  层级结构数据的树状输出</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>还是以应用一的数组为例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line">    <span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'1'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>, <span class="string">'name'</span> =&gt; <span class="string">'一级栏目一'</span>),</span><br><span class="line">    <span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'2'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'二级栏目一'</span>),</span><br><span class="line">    <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'3'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'二级栏目二'</span>),</span><br><span class="line">    <span class="number">3</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'4'</span>, <span class="string">'pid'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目一'</span>),</span><br><span class="line">    <span class="number">4</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'5'</span>, <span class="string">'pid'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目二'</span>),</span><br><span class="line">    <span class="number">5</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'6'</span>, <span class="string">'pid'</span> =&gt; <span class="number">3</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目三'</span>),</span><br><span class="line">    <span class="number">6</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'7'</span>, <span class="string">'pid'</span> =&gt; <span class="number">3</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目四'</span>),</span><br><span class="line">    <span class="number">7</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'8'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>, <span class="string">'name'</span> =&gt; <span class="string">'一级栏目二'</span>),</span><br><span class="line">    <span class="number">8</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'9'</span>, <span class="string">'pid'</span> =&gt; <span class="number">8</span>, <span class="string">'name'</span> =&gt; <span class="string">'二级栏目三'</span>),</span><br><span class="line">    <span class="number">9</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'10'</span>, <span class="string">'pid'</span> =&gt; <span class="number">7</span>, <span class="string">'name'</span> =&gt; <span class="string">'四级栏目一'</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>输出结果<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">一级栏目一</span><br><span class="line"></span><br><span class="line">    ├─ 二级栏目一</span><br><span class="line"></span><br><span class="line">    │    ├─ 三级栏目一</span><br><span class="line"></span><br><span class="line">    │    └─ 三级栏目二</span><br><span class="line"></span><br><span class="line">    └─ 二级栏目二</span><br><span class="line"></span><br><span class="line">        ├─ 三级栏目三</span><br><span class="line"></span><br><span class="line">        └─ 三级栏目四</span><br><span class="line"></span><br><span class="line">            └─ 四级栏目一</span><br><span class="line"></span><br><span class="line">一级栏目二</span><br><span class="line"></span><br><span class="line">    └─ 二级栏目三</span></span><br></pre></td></tr></table></figure></p>
<p>还能以select形式展现<br><img src="http://i1.piimg.com/567571/f6d7fd8526484939.png" alt=""><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tree</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $arr = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">var</span> $icon = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'│'</span>,</span><br><span class="line">        <span class="string">'├─'</span>,</span><br><span class="line">        <span class="string">'└─'</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">var</span> $ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tree</span><span class="params">($arr = array<span class="params">()</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arr = $arr;</span><br><span class="line">        <span class="keyword">return</span> is_array($arr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_child</span><span class="params">($myid)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $newarr = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="keyword">$this</span>-&gt;arr)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;arr <span class="keyword">as</span> $id =&gt; $a) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($a[<span class="string">'pid'</span>] == $myid) &#123;</span><br><span class="line">                    $newarr[$id] = $a;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $newarr ? $newarr : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取带格式数组</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getArray</span><span class="params">($myid = <span class="number">0</span>, $sid = <span class="number">0</span>, $adds = <span class="string">''</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $number = <span class="number">1</span>;</span><br><span class="line">        $child = <span class="keyword">$this</span>-&gt;get_child($myid);</span><br><span class="line">        <span class="keyword">if</span> (is_array($child)) &#123;</span><br><span class="line">            $total = count($child);</span><br><span class="line">            <span class="keyword">foreach</span> ($child <span class="keyword">as</span> $a) &#123;</span><br><span class="line">                $j = $k = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">if</span> ($number == $total) &#123;</span><br><span class="line">                    $j .= <span class="keyword">$this</span>-&gt;icon[<span class="number">2</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $j .= <span class="keyword">$this</span>-&gt;icon[<span class="number">1</span>];</span><br><span class="line">                    $k = $adds ? <span class="keyword">$this</span>-&gt;icon[<span class="number">0</span>] : <span class="string">''</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                $spacer = $adds ? $adds . $j : <span class="string">''</span>;</span><br><span class="line">                $a[<span class="string">'name'</span>] = $spacer . <span class="string">' '</span> . $a[<span class="string">'name'</span>];</span><br><span class="line">                <span class="keyword">$this</span>-&gt;ret[] = $a;</span><br><span class="line">                $fd = $adds . $k . <span class="string">'&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;'</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;getArray($a[<span class="string">'id'</span>], $sid, $fd);</span><br><span class="line">                $number++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//select</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_tree</span><span class="params">($myid, $str, $sid = <span class="number">0</span>, $adds = <span class="string">''</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $number = <span class="number">1</span>;</span><br><span class="line">        $child = <span class="keyword">$this</span>-&gt;get_child($myid);</span><br><span class="line">        <span class="keyword">if</span> (is_array($child)) &#123;</span><br><span class="line">            $total = count($child);</span><br><span class="line">            <span class="keyword">foreach</span> ($child <span class="keyword">as</span> $a) &#123;</span><br><span class="line">                $id = $a[<span class="string">'id'</span>];</span><br><span class="line">                $j = $k = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">if</span> ($number == $total) &#123;</span><br><span class="line">                    $j .= <span class="keyword">$this</span>-&gt;icon [<span class="number">2</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $j .= <span class="keyword">$this</span>-&gt;icon [<span class="number">1</span>];</span><br><span class="line">                    $k = $adds ? <span class="keyword">$this</span>-&gt;icon [<span class="number">0</span>] : <span class="string">''</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                $spacer = $adds ? $adds . $j : <span class="string">''</span>;</span><br><span class="line">                $select = $id == $sid ? <span class="string">'selected'</span> : <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">$this</span>-&gt;ret .= sprintf($str, $id, $select, $spacer, $a[<span class="string">'name'</span>]);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;get_tree($id, $str, $sid, $adds . $k . <span class="string">'&amp;nbsp;'</span>);</span><br><span class="line">                $number++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//文件夹目录</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read_all_dir</span><span class="params">($dir, $onlyDir = true)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $result = <span class="keyword">array</span>();</span><br><span class="line">        $handle = opendir($dir);</span><br><span class="line">        <span class="keyword">if</span> ($handle) &#123;</span><br><span class="line">            <span class="keyword">while</span> (($file = readdir($handle)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($file != <span class="string">'.'</span> &amp;&amp; $file != <span class="string">'..'</span>) &#123;</span><br><span class="line">                    $cur_path = $dir . DIRECTORY_SEPARATOR . $file;</span><br><span class="line">                    <span class="keyword">if</span> (is_dir($cur_path)) &#123;</span><br><span class="line">                        $result[$file] = <span class="keyword">$this</span>-&gt;read_all_dir($cur_path, $onlyDir);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!$onlyDir) &#123;</span><br><span class="line">                            $result[] = $file;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            closedir($handle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//数组转换</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">arrshift</span><span class="params">($array, $pid = <span class="number">0</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $r = [];</span><br><span class="line">        <span class="keyword">static</span> $index = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (is_array($array) &amp;&amp; count($array) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $r[] = <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">'id'</span> =&gt; $index,</span><br><span class="line">                    <span class="string">'pid'</span> =&gt; $pid,</span><br><span class="line">                    <span class="string">'name'</span> =&gt; is_array($v) ? $k : $v</span><br><span class="line">                );</span><br><span class="line">                $index++;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;arrshift($v, $index - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $r;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>得出数组用foreach循环即可输出树形结构<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$tree = <span class="keyword">new</span> Tree ();</span><br><span class="line">$tree-&gt;tree($data);</span><br><span class="line">$result = $tree-&gt;getArray();</span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $value) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $value[<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里给出option模板<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$html = <span class="string">'&lt;select name="tree"&gt;'</span>;</span><br><span class="line">$str = <span class="string">"&lt;option value=%s %s&gt;%s%s&lt;/option&gt;"</span>;</span><br><span class="line">$html .= $tree-&gt;get_tree(<span class="number">0</span>, $str, <span class="number">2</span>) . <span class="string">'&lt;/select&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $html;</span><br></pre></td></tr></table></figure></p>
<p>即可输出select<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get_tree($myid, $str, $sid = <span class="number">0</span>, $adds = <span class="string">''</span>)</span><br></pre></td></tr></table></figure></p>
<p>这里是<code>$sid</code>参数是给出slected的option的id</p>
<p>利用应用一的数组无限极分类和还原以及应用二的文件夹目录的遍历<br>可以树状结构输出文件夹目录<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$tree = <span class="keyword">new</span> Tree (); <span class="comment">// new 之前请记得包含tree文件!</span></span><br><span class="line"><span class="comment">//文件夹遍历</span></span><br><span class="line">$data = $tree-&gt;read_all_dir(<span class="string">'/web/mall/Application/lib'</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="comment">//转换成[['id','pid','name']]的二维数组</span></span><br><span class="line">$data = $tree-&gt;arrshift($data);</span><br><span class="line">$tree-&gt;tree($data); </span><br><span class="line">$data = $tree-&gt;getArray();</span><br><span class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $value) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $value[<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以得到我们想要的结果<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Action</span><br><span class="line"></span><br><span class="line">    ├─ Admin</span><br><span class="line"></span><br><span class="line">    │    ├─ GoodAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ IndexAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ LoginAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ MenuAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ OrderAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ PublicAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ UserAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ UtilAction.class.php</span><br><span class="line"></span><br><span class="line">    │    ├─ WechatAction.class.php</span><br><span class="line"></span><br><span class="line">    │    └─ WeixinAction.class.php</span><br><span class="line"></span><br><span class="line">    ├─ Api</span><br><span class="line"></span><br><span class="line">    │    └─ ApiAction.class.php</span><br><span class="line"></span><br><span class="line">    └─ App</span><br><span class="line"></span><br><span class="line">        ├─ IndexAction.class.php</span><br><span class="line"></span><br><span class="line">        └─ Sms.class.php</span><br><span class="line"></span><br><span class="line">log.txt</span><br><span class="line"></span><br><span class="line">Model</span><br><span class="line"></span><br><span class="line">    ├─ Admin</span><br><span class="line"></span><br><span class="line">    │    └─ OrderModel.class.php</span><br><span class="line"></span><br><span class="line">    └─ App</span><br><span class="line"></span><br><span class="line">        └─ OrderModel.class.php</span><br></pre></td></tr></table></figure></p>
<p>虽然递归函数的效率和性能欠佳，但是对我们的逻辑训练还是有很大帮助的，我们可以写出一个方法并不断的优化和简单化，来提高我们的逻辑</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/15/php 递归函数的应用(三) 层级结构数据的树状输出/" data-id="ciwc4lj5t000fgo7znu2ss64v" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/递归/">递归</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-php 递归函数的应用(二) 文件夹目录遍历" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/14/php 递归函数的应用(二) 文件夹目录遍历/" class="article-date">
  <time datetime="2016-11-14T09:17:56.000Z" itemprop="datePublished">2016-11-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/14/php 递归函数的应用(二) 文件夹目录遍历/">PHP 递归函数的应用(二) 文件夹目录遍历</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>文件夹目录的遍历同样也利用递归去一层一层的遍历文件</p>
<p>以下面这个目录为例的<br><img src="http://p1.bpimg.com/567571/58d86ac7bdb3bfc0.png" alt=""></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//$onlyDir 是否只输出目录</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dirList</span><span class="params">($dir, $onlyDir = true)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $result = <span class="keyword">array</span>();</span><br><span class="line">    $handle = opendir($dir);</span><br><span class="line">    <span class="keyword">if</span> ($handle) &#123;</span><br><span class="line">        <span class="keyword">while</span> (($file = readdir($handle)) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($file != <span class="string">'.'</span> &amp;&amp; $file != <span class="string">'..'</span>) &#123;</span><br><span class="line">                $cur_path = $dir . DIRECTORY_SEPARATOR . $file;</span><br><span class="line">                <span class="keyword">if</span> (is_dir($cur_path)) &#123;</span><br><span class="line">                    $result[$file] = dirList($cur_path, $onlyDir);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!$onlyDir) &#123;</span><br><span class="line">                        $result[] = $file;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        closedir($handle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行<code>dirList(&#39;/web/mall/Application/lib&#39;, false)</code><br>打印数组<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">array(3) &#123;</span><br><span class="line">  ["Action"]=&gt;</span><br><span class="line">  array(3) &#123;</span><br><span class="line">    ["Admin"]=&gt;</span><br><span class="line">    array(10) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(20) "GoodAction.class.php"</span><br><span class="line">      [1]=&gt;</span><br><span class="line">      string(21) "IndexAction.class.php"</span><br><span class="line">      [2]=&gt;</span><br><span class="line">      string(21) "LoginAction.class.php"</span><br><span class="line">      [3]=&gt;</span><br><span class="line">      string(20) "MenuAction.class.php"</span><br><span class="line">      [4]=&gt;</span><br><span class="line">      string(21) "OrderAction.class.php"</span><br><span class="line">      [5]=&gt;</span><br><span class="line">      string(22) "PublicAction.class.php"</span><br><span class="line">      [6]=&gt;</span><br><span class="line">      string(20) "UserAction.class.php"</span><br><span class="line">      [7]=&gt;</span><br><span class="line">      string(20) "UtilAction.class.php"</span><br><span class="line">      [8]=&gt;</span><br><span class="line">      string(22) "WechatAction.class.php"</span><br><span class="line">      [9]=&gt;</span><br><span class="line">      string(22) "WeixinAction.class.php"</span><br><span class="line">    &#125;</span><br><span class="line">    ["Api"]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(19) "ApiAction.class.php"</span><br><span class="line">    &#125;</span><br><span class="line">    ["App"]=&gt;</span><br><span class="line">    array(2) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(21) "IndexAction.class.php"</span><br><span class="line">      [1]=&gt;</span><br><span class="line">      string(13) "Sms.class.php"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(7) "log.txt"</span><br><span class="line">  ["Model"]=&gt;</span><br><span class="line">  array(2) &#123;</span><br><span class="line">    ["Admin"]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(20) "OrderModel.class.php"</span><br><span class="line">    &#125;</span><br><span class="line">    ["App"]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(20) "OrderModel.class.php"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>可以很清晰的看出一层一层的结构</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/14/php 递归函数的应用(二) 文件夹目录遍历/" data-id="ciwc4lj5s000ego7zquhutipn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/递归/">递归</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-php 递归函数的应用(一) 数组的无限级分类和逆过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/14/php 递归函数的应用(一) 数组的无限级分类和逆过程/" class="article-date">
  <time datetime="2016-11-14T08:52:01.000Z" itemprop="datePublished">2016-11-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/14/php 递归函数的应用(一) 数组的无限级分类和逆过程/">PHP 递归函数的应用(一) 数组的无限级分类和逆过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>递归函数最基本的特点就是自身调用自身，在调用自身前有条件判断，否则会无限调用下去。在日常开发也会很常见，对逻辑性要求也较高，要想灵活的去运用，还需要多加尝试，利用递归，可以对数组进行无限极的分类，还可以对无限极分类的数组进行还原。</p>
<h4 id="先看看无限极分类"><a href="#先看看无限极分类" class="headerlink" title="先看看无限极分类"></a>先看看无限极分类</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line">    <span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'1'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>, <span class="string">'name'</span> =&gt; <span class="string">'一级栏目一'</span>),</span><br><span class="line">    <span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'2'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'二级栏目一'</span>),</span><br><span class="line">    <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'3'</span>, <span class="string">'pid'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'二级栏目二'</span>),</span><br><span class="line">    <span class="number">3</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'4'</span>, <span class="string">'pid'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目一'</span>),</span><br><span class="line">    <span class="number">4</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'5'</span>, <span class="string">'pid'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目二'</span>),</span><br><span class="line">    <span class="number">5</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'6'</span>, <span class="string">'pid'</span> =&gt; <span class="number">3</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目三'</span>),</span><br><span class="line">    <span class="number">6</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'7'</span>, <span class="string">'pid'</span> =&gt; <span class="number">3</span>, <span class="string">'name'</span> =&gt; <span class="string">'三级栏目四'</span>),</span><br><span class="line">    <span class="number">7</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'8'</span>, <span class="string">'pid'</span> =&gt; <span class="number">0</span>, <span class="string">'name'</span> =&gt; <span class="string">'一级栏目二'</span>),</span><br><span class="line">    <span class="number">8</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'9'</span>, <span class="string">'pid'</span> =&gt; <span class="number">8</span>, <span class="string">'name'</span> =&gt; <span class="string">'二级栏目三'</span>),</span><br><span class="line">    <span class="number">9</span> =&gt; <span class="keyword">array</span>(<span class="string">'id'</span> =&gt; <span class="string">'10'</span>, <span class="string">'pid'</span> =&gt; <span class="number">7</span>, <span class="string">'name'</span> =&gt; <span class="string">'四级栏目一'</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//无限极分类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assortArray</span><span class="params">($data, $pid = <span class="number">0</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $r = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> ($list <span class="keyword">as</span> $id =&gt; $item) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($item[<span class="string">'pid'</span>] == $pid) &#123;</span><br><span class="line">            $length = count($r);</span><br><span class="line">            $r[$length] = $item;</span><br><span class="line">            <span class="keyword">if</span> ($t = assortArray($list, $item[<span class="string">'id'</span>])) &#123;</span><br><span class="line">                $r[$length][<span class="string">'children'</span>] = $t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//还原</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arrRecove</span><span class="params">($array)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $r = [];</span><br><span class="line">    <span class="keyword">if</span> (is_array($array) &amp;&amp; count($array) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            $r[] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'id'</span> =&gt; $v[<span class="string">'id'</span>],</span><br><span class="line">                <span class="string">'pid'</span> =&gt; $v[<span class="string">'pid'</span>],</span><br><span class="line">                <span class="string">'name'</span> =&gt; $v[<span class="string">'name'</span>]</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($v[<span class="string">'children'</span>])) &#123;</span><br><span class="line">                arrRecove($v[<span class="string">'children'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用以后输出，可以看到结果<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  array(4) &#123;</span><br><span class="line">    ["id"]=&gt;</span><br><span class="line">    string(1) "1"</span><br><span class="line">    ["pid"]=&gt;</span><br><span class="line">    int(0)</span><br><span class="line">    ["name"]=&gt;</span><br><span class="line">    string(15) "一级栏目一"</span><br><span class="line">    ["children"]=&gt;</span><br><span class="line">    array(2) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      array(4) &#123;</span><br><span class="line">        ["id"]=&gt;</span><br><span class="line">        string(1) "2"</span><br><span class="line">        ["pid"]=&gt;</span><br><span class="line">        int(1)</span><br><span class="line">        ["name"]=&gt;</span><br><span class="line">        string(15) "二级栏目一"</span><br><span class="line">        ["children"]=&gt;</span><br><span class="line">        array(2) &#123;</span><br><span class="line">          [0]=&gt;</span><br><span class="line">          array(3) &#123;</span><br><span class="line">            ["id"]=&gt;</span><br><span class="line">            string(1) "4"</span><br><span class="line">            ["pid"]=&gt;</span><br><span class="line">            int(2)</span><br><span class="line">            ["name"]=&gt;</span><br><span class="line">            string(15) "三级栏目一"</span><br><span class="line">          &#125;</span><br><span class="line">          [1]=&gt;</span><br><span class="line">          array(3) &#123;</span><br><span class="line">            ["id"]=&gt;</span><br><span class="line">            string(1) "5"</span><br><span class="line">            ["pid"]=&gt;</span><br><span class="line">            int(2)</span><br><span class="line">            ["name"]=&gt;</span><br><span class="line">            string(15) "三级栏目二"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      [1]=&gt;</span><br><span class="line">      array(4) &#123;</span><br><span class="line">        ["id"]=&gt;</span><br><span class="line">        string(1) "3"</span><br><span class="line">        ["pid"]=&gt;</span><br><span class="line">        int(1)</span><br><span class="line">        ["name"]=&gt;</span><br><span class="line">        string(15) "二级栏目二"</span><br><span class="line">        ["children"]=&gt;</span><br><span class="line">        array(2) &#123;</span><br><span class="line">          [0]=&gt;</span><br><span class="line">          array(3) &#123;</span><br><span class="line">            ["id"]=&gt;</span><br><span class="line">            string(1) "6"</span><br><span class="line">            ["pid"]=&gt;</span><br><span class="line">            int(3)</span><br><span class="line">            ["name"]=&gt;</span><br><span class="line">            string(15) "三级栏目三"</span><br><span class="line">          &#125;</span><br><span class="line">          [1]=&gt;</span><br><span class="line">          array(4) &#123;</span><br><span class="line">            ["id"]=&gt;</span><br><span class="line">            string(1) "7"</span><br><span class="line">            ["pid"]=&gt;</span><br><span class="line">            int(3)</span><br><span class="line">            ["name"]=&gt;</span><br><span class="line">            string(15) "三级栏目四"</span><br><span class="line">            ["children"]=&gt;</span><br><span class="line">            array(1) &#123;</span><br><span class="line">              [0]=&gt;</span><br><span class="line">              array(3) &#123;</span><br><span class="line">                ["id"]=&gt;</span><br><span class="line">                string(2) "10"</span><br><span class="line">                ["pid"]=&gt;</span><br><span class="line">                int(7)</span><br><span class="line">                ["name"]=&gt;</span><br><span class="line">                string(15) "四级栏目一"</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  array(4) &#123;</span><br><span class="line">    ["id"]=&gt;</span><br><span class="line">    string(1) "8"</span><br><span class="line">    ["pid"]=&gt;</span><br><span class="line">    int(0)</span><br><span class="line">    ["name"]=&gt;</span><br><span class="line">    string(15) "一级栏目二"</span><br><span class="line">    ["children"]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      array(3) &#123;</span><br><span class="line">        ["id"]=&gt;</span><br><span class="line">        string(1) "9"</span><br><span class="line">        ["pid"]=&gt;</span><br><span class="line">        int(8)</span><br><span class="line">        ["name"]=&gt;</span><br><span class="line">        string(15) "二级栏目三"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到最外层的数组只有我们的一级栏目，然后子栏目都嵌套在其中</p>
<p>运行<code>arrRecove()</code>方法，即可把数组还原到二维数组</p>
<p>甚至可以用一种更简单粗暴的分级<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无限极分类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assortArray</span><span class="params">($data, $pid = <span class="number">0</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $r = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> ($list <span class="keyword">as</span> $id =&gt; $item) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($item[<span class="string">'pid'</span>] == $pid) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($t = assortArray($list, $item[<span class="string">'id'</span>])) &#123;</span><br><span class="line">                $r[$item[<span class="string">'name'</span>]] = $t;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $r[] = $item[<span class="string">'name'</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//还原</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arrshift</span><span class="params">($array, $pid = <span class="number">0</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $r = [];</span><br><span class="line">    <span class="keyword">static</span> $index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_array($array) &amp;&amp; count($array) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            $r[] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'id'</span> =&gt; $index,</span><br><span class="line">                <span class="string">'pid'</span> =&gt; $pid,</span><br><span class="line">                <span class="string">'name'</span> =&gt; is_array($v) ? $k : $v</span><br><span class="line">            );</span><br><span class="line">            $index++;</span><br><span class="line">            arrshift($v, $index - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行分级方法可以看到<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">array(2) &#123;</span><br><span class="line">  ["一级栏目一"]=&gt;</span><br><span class="line">	  array(2) &#123;</span><br><span class="line">	    ["二级栏目一"]=&gt;</span><br><span class="line">	    array(2) &#123;</span><br><span class="line">	      [0]=&gt;</span><br><span class="line">	      string(15) "三级栏目一"</span><br><span class="line">	      [1]=&gt;</span><br><span class="line">	      string(15) "三级栏目二"</span><br><span class="line">	    &#125;</span><br><span class="line">	    ["二级栏目二"]=&gt;</span><br><span class="line">	    array(2) &#123;</span><br><span class="line">	      [0]=&gt;</span><br><span class="line">	      string(15) "三级栏目三"</span><br><span class="line">	      ["三级栏目四"]=&gt;</span><br><span class="line">	      array(1) &#123;</span><br><span class="line">	        [0]=&gt;</span><br><span class="line">	        string(15) "四级栏目一"</span><br><span class="line">	      &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">  ["一级栏目二"]=&gt;</span><br><span class="line">	  array(1) &#123;</span><br><span class="line">	    [0]=&gt;</span><br><span class="line">	    string(15) "二级栏目三"</span><br><span class="line">	  &#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>运行<code>arrRecove()</code>方法，同样可以把数组还原到二维数组</p>
<p>不同的分级方式，还原的方法也就不一样</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/14/php 递归函数的应用(一) 数组的无限级分类和逆过程/" data-id="ciwc4lj5k000bgo7zbami5cgn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/递归/">递归</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-php中的路径研究 以及 .: ..:  __DIR__ __FILE__ getcwd() 的用法和区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/11/php中的路径研究 以及 .: ..:  __DIR__ __FILE__ getcwd() 的用法和区别/" class="article-date">
  <time datetime="2016-11-11T08:23:14.000Z" itemprop="datePublished">2016-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/11/php中的路径研究 以及 .: ..:  __DIR__ __FILE__ getcwd() 的用法和区别/">php中的路径研究和./ ../  __DIR__ __FILE__ getcwd() 的用法和区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>当前环境是mac，项目目录是<code>/web/</code><br>路径的问题特别容易混淆，特别是在include和require_once或者file_get_content()的时候，<br>view里面展示图片也会出现路径错误的问题</p>
<p><code>.</code>表示当前目录<br><code>..</code>表示当前目录的上一级目录。<br><code>./</code>表示当前目录下的某个文件或文件夹，<br><code>../</code>表示当前目录上一级目录的文件或文件夹</p>
<h4 id="先简单举个例子"><a href="#先简单举个例子" class="headerlink" title="先简单举个例子"></a>先简单举个例子</h4><p><img src="http://p1.bpimg.com/4851/2384e3fcf182f411.png" alt=""></p>
<p>在<code>index.html</code>中引用css</p>
<p>当前目录(b)下的css文件夹<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">'css/main.css'</span>/&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">'./css/main.css'</span>/&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>再或者是<br>当前目录的上级目录(demo)下的b目录下的css目录<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">'../b/css/main.css'</span>/&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>使用图片<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"test2.jpg"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../a/test1.jpg"</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>类似php中也是<br>在index.php中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">"c/user.php"</span>;</span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"./c/user.php"</span>;</span><br></pre></td></tr></table></figure></p>
<p>在user.php中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">"../index.php"</span>;</span><br></pre></td></tr></table></figure></p>
<p>getcwd() ：在哪个文件里调用此文件的目录</p>
<p>__DIR__ ： 当前内容写在哪个文件的目录</p>
<p>__FILE__ ：当前内容写在哪个文件的目录+文件名</p>
<h3 id="有个问题在项目中很容易出错"><a href="#有个问题在项目中很容易出错" class="headerlink" title="有个问题在项目中很容易出错"></a>有个问题在项目中很容易出错</h3><p>我们经常会在项目中require或者include引用某个php文件</p>
<p><img src="http://p1.bqimg.com/4851/bc16e046b6918fa6.png" alt=""></p>
<p>以yii基础版框架随便举个例子<br>运行UserController的actionList<br><code>localhost/demo/web/index.php?r=admin/user/list</code></p>
<p>在UserController中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="keyword">__DIR__</span>;  </span><br><span class="line"><span class="comment">// 当前内容写在哪个文件(UserController.php)的目录admin</span></span><br><span class="line"><span class="comment">// /web/demo/controllers/admin</span></span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">__FILE__</span>; </span><br><span class="line"><span class="comment">// /web/demo/controllers/admin/UserController.php</span></span><br><span class="line"><span class="keyword">echo</span> getcwd(); </span><br><span class="line"><span class="comment">// 在入口文件index.php中调用的此文件，所以是index.php的目录</span></span><br><span class="line"><span class="comment">// /web/demo/web</span></span><br></pre></td></tr></table></figure></p>
<p>然后我们在UserController.php中require_once submit.php<br>我们可能会跟上面的例子那样，以当前文件为基准去写相对路径<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">"../../alipay/lib/submit.php"</span></span><br></pre></td></tr></table></figure></p>
<p>然后我们运行，却发现报错了<br><code>Failed opening required &#39;../../alipay/lib/submit.php</code></p>
<p>“UserController.php所在目录(admin)的上级目录(controllers)的上级目录(demo)下面的alipay下面的lib”<br>“对啊，../../没错啊”</p>
<p>仔细思考后 我们的url <code>localhost/demo/web/index.php?r=admin/user/list</code><br>我们这里的相对路径是以index.php为基准的</p>
<p>所以这里我们应该这么写<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">"../alipay/lib/submit.php"</span></span><br></pre></td></tr></table></figure></p>
<p>运行发现成功</p>
<p>其实这里也可以这么写相对路径<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php文件所在目录(web)的上级目录(demo)下的alipay</span></span><br><span class="line"><span class="keyword">require_once</span> getcwd().<span class="string">"/../alipay/lib/submit.php"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前文件目录(admin)的上级目录(controllers)的上级目录(demo)下的alipay</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">"/../../alipay/lib/submit.php"</span></span><br></pre></td></tr></table></figure></p>
<p>如果我们在入口文件(<code>index.php</code>)定义一个全局的变量<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'BASE_PATH'</span>, str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, realpath(dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/../'</span>)));</span><br></pre></td></tr></table></figure></p>
<p>不管在哪里<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> BASE_PATH</span><br></pre></td></tr></table></figure></p>
<p>都会输出我们的根目录<br><code>/web/demo</code></p>
<p>那么刚才的可以写成绝对路径<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> BASE_PATH.<span class="string">"/alipay/lib/submit.php"</span></span><br></pre></td></tr></table></figure></p>
<p>这样代码迁移起来也更方便</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/11/php中的路径研究 以及 .: ..:  __DIR__ __FILE__ getcwd() 的用法和区别/" data-id="ciwc4lj5h0009go7z4wigigbp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-微信开发常用接口的PHP封装" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/04/微信开发常用接口的PHP封装/" class="article-date">
  <time datetime="2016-11-04T06:14:29.000Z" itemprop="datePublished">2016-11-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/04/微信开发常用接口的PHP封装/">微信开发常用接口的PHP封装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>微信接口这块的东西不是弄起来不算特别难，封装好了基本都能复用，不过没做过微信开发的同学第一次整起来还是显得有些蛋疼的。</p>
<p>常用的开发主要分4块<br>1.<code>access_token的获取和存放</code>：获取access_token的接口是有调用频率的限制的，我们不能每次需要的时候都去调用接口，我们可以将其写入文件，或者写入缓存。access_token的有效期目前为2个小时，每次拿的时候先将我们存放的时间和当前时间作对比，超过7200秒才去请求接口，否则直接拿文件或缓存里面存放的access_token</p>
<p>2.<code>JS-SDK</code>：这块主要是应用于微信的网页开发，可以直接使用微信提供的包括扫描二维码，上传图片，分享，定位等很多接口。具体可见<a href="https://mp.weixin.qq.com/wiki/11/74ad127cc054f6b80759c40f77ec03db.html" target="_blank" rel="external">JS-SDK文档</a>和官方<a href="http://demo.open.weixin.qq.com/jssdk" target="_blank" rel="external">demo</a>。所有需要使用JS-SDK的页面必须先注入配置信息，获取配置信息的接口，需要一个jsapi_ticket，和access_token一样，有效期也是2个小时，这里我们要做的也是存放jsapi_ticket和拿取配置信息<br><code>注意</code>：这里需要到微信公众平台里面设置我们的JS接口安全域名，否则是用不了的</p>
<p>3.<code>网页授权</code>：这里主要是网页授权获取用户信息，然后插入或者更新的user表</p>
<ul>
<li>引导用户进入授权页面同意授权，获取code</li>
<li>通过code换取网页授权access_token（与基础支持中的access_token不同）</li>
<li>如果需要，开发者可以刷新网页授权access_token，避免过期</li>
<li>通过网页授权access_token和openid获取用户基本信息（支持UnionID机制）</li>
</ul>
<p><code>注意</code>：这里需要到微信公众平台里面设置我们网页授权域名</p>
<p>4.<code>服务器配置</code>:这里主要是作为一个回调，可以监听到用户的事件，比如关注，取关，click事件，接受用户发送的信息，这样我们可以跟各种事件或者信息来进行我们的逻辑</p>
<p>代码如下</p>
<p>1.<code>access_token的获取和存放</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Token</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 微信配置信息</span><br><span class="line">     * <span class="doctag">@var</span> array</span><br><span class="line">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">createAccessToken</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">	    <span class="comment">//微信配置</span></span><br><span class="line">        $appid = Yii::$app-&gt;params[<span class="string">'WeChat'</span>][<span class="string">'AppID'</span>];</span><br><span class="line">        $corpsecret = Yii::$app-&gt;params[<span class="string">'WeChat'</span>][<span class="string">'AppSecret'</span>];</span><br><span class="line"></span><br><span class="line">        $url = <span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=$appid&amp;secret=$corpsecret"</span>;</span><br><span class="line">        $accessTokenJSON = file_get_contents($url);</span><br><span class="line">        $accessTokenArr = json_decode($accessTokenJSON, <span class="keyword">true</span>);</span><br><span class="line">        $accessTokenArr[<span class="string">'timestamp'</span>] = time();</span><br><span class="line">        $write = <span class="keyword">$this</span>-&gt;createFile(json_encode($accessTokenArr));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($accessTokenArr[<span class="string">'access_token'</span>]) &amp;&amp; $write) &#123;</span><br><span class="line">            <span class="keyword">return</span> $accessTokenArr[<span class="string">'access_token'</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>($accessTokenJSON);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 读取accessToken</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAccessToken</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $currentTimestamp = time(); <span class="comment">// 当前时间戳</span></span><br><span class="line">        $accessTokenJSON = file_get_contents(<span class="keyword">__DIR__</span> . <span class="string">'/../wechat/params/token.json'</span>);</span><br><span class="line">        $accessTokenArr = json_decode($accessTokenJSON, <span class="keyword">true</span>);</span><br><span class="line">        $timestamp = $currentTimestamp - $accessTokenArr[<span class="string">'timestamp'</span>];</span><br><span class="line">        <span class="keyword">if</span> ($timestamp &lt; <span class="number">7200</span>) &#123;<span class="comment">// token 有效期2个小时</span></span><br><span class="line">            <span class="keyword">return</span> $accessTokenArr[<span class="string">'access_token'</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//请求接口</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createAccessToken();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 创建临时文件</span><br><span class="line">     * <span class="doctag">@param</span>  $content</span><br><span class="line">     * <span class="doctag">@return</span> boolean 创建文件是否成功</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createFile</span><span class="params">($content)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $filename = <span class="keyword">__DIR__</span> . <span class="string">'/../wechat/params/token.json'</span>;</span><br><span class="line">        $file = fopen($filename, <span class="string">"w"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</span><br><span class="line">        $txt = $content;</span><br><span class="line">        $count = strlen($content);</span><br><span class="line">        <span class="keyword">if</span> ($count === fwrite($file, $txt)) &#123;<span class="comment">// 根据写入内容长度判断文件是否写入,</span></span><br><span class="line">            fclose($file);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fclose($file);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.<code>JS-SDK</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jssdk</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $appId;</span><br><span class="line">    <span class="keyword">private</span> $appSecret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;appId = Yii::$app-&gt;params[<span class="string">'WeChat'</span>][<span class="string">'AppID'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;appSecret = Yii::$app-&gt;params[<span class="string">'WeChat'</span>][<span class="string">'AppSecret'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSignPackage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $jsapiTicket = <span class="keyword">$this</span>-&gt;getJsApiTicket();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意 URL 一定要动态获取，不能 hardcode.</span></span><br><span class="line">        $protocol = (!<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTPS'</span>]) &amp;&amp; $_SERVER[<span class="string">'HTTPS'</span>] !== <span class="string">'off'</span> || $_SERVER[<span class="string">'SERVER_PORT'</span>] == <span class="number">443</span>) ? <span class="string">"https://"</span> : <span class="string">"http://"</span>;</span><br><span class="line">        $url = <span class="string">"$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"</span>;</span><br><span class="line"></span><br><span class="line">        $timestamp = time();</span><br><span class="line">        $nonceStr = <span class="keyword">$this</span>-&gt;createNonceStr();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里参数的顺序要按照 key 值 ASCII 码升序排序</span></span><br><span class="line">        $string = <span class="string">"jsapi_ticket=$jsapiTicket&amp;noncestr=$nonceStr&amp;timestamp=$timestamp&amp;url=$url"</span>;</span><br><span class="line"></span><br><span class="line">        $signature = sha1($string);</span><br><span class="line"></span><br><span class="line">        $signPackage = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">"appId"</span> =&gt; <span class="keyword">$this</span>-&gt;appId,</span><br><span class="line">            <span class="string">"nonceStr"</span> =&gt; $nonceStr,</span><br><span class="line">            <span class="string">"timestamp"</span> =&gt; $timestamp,</span><br><span class="line">            <span class="string">"url"</span> =&gt; $url,</span><br><span class="line">            <span class="string">"signature"</span> =&gt; $signature,</span><br><span class="line">            <span class="string">"rawString"</span> =&gt; $string</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> $signPackage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">createNonceStr</span><span class="params">($length = <span class="number">16</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $chars = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span>;</span><br><span class="line">        $str = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">            $str .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getJsApiTicket</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// jsapi_ticket 应该全局存储与更新，以下代码以写入到文件中做示例</span></span><br><span class="line">        $data = json_decode(<span class="keyword">$this</span>-&gt;get_ticket_file(), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> ($data[<span class="string">'expire_time'</span>] &lt; time()) &#123;</span><br><span class="line">	        $tokenClass = <span class="keyword">new</span> Token();</span><br><span class="line">            $accessToken = $tokenClass-&gt;getAccessToken();</span><br><span class="line">            $url = <span class="string">"https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&amp;access_token=$accessToken"</span>;</span><br><span class="line">            $resJson = file_get_contents($url);</span><br><span class="line">            $res = json_decode($resJson, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($res[<span class="string">'ticket'</span>])) &#123;</span><br><span class="line">                $ticket = $res[<span class="string">'ticket'</span>];</span><br><span class="line">                $data[<span class="string">'expire_time'</span>] = time() + <span class="number">7200</span>;</span><br><span class="line">                $data[<span class="string">'jsapi_ticket'</span>] = $ticket;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;set_php_file(json_encode($data));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">die</span>($resJson);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $ticket = $data[<span class="string">'jsapi_ticket'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $ticket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_ticket_file</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">__DIR__</span> . <span class="string">"/../wechat/params/jsapi_ticket.json"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">set_php_file</span><span class="params">($content)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $filename = <span class="keyword">__DIR__</span> . <span class="string">"/../wechat/params/jsapi_ticket.json"</span>;</span><br><span class="line">        $fp = fopen($filename, <span class="string">"w"</span>);</span><br><span class="line">        fwrite($fp, $content);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过getSignPackage()获取配置信息后就可以在网页部分调用了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"http://res.wx.qq.com/open/js/jweixin-1.0.0.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  wx.config(&#123;</span><br><span class="line">    debug: <span class="literal">true</span>,</span><br><span class="line">    appId: <span class="string">'&lt;?php echo $signPackage["appId"];?&gt;'</span>,</span><br><span class="line">    timestamp: <span class="xml"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $signPackage[<span class="string">"timestamp"</span>];<span class="meta">?&gt;</span></span>,</span><br><span class="line">    nonceStr: '<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $signPackage[<span class="string">"nonceStr"</span>];<span class="meta">?&gt;</span></span>',</span><br><span class="line">    signature: '<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $signPackage[<span class="string">"signature"</span>];<span class="meta">?&gt;</span></span>',</span><br><span class="line">    jsApiList: [</span><br><span class="line">      // 所有要调用的 API 都要加到这个列表中</span><br><span class="line">    ]</span><br><span class="line">  &#125;);</span><br><span class="line">  wx.ready(function () &#123;</span><br><span class="line">    // 在这里调用 API</span><br><span class="line">    'checkJsApi',</span><br><span class="line">    'onMenuShareTimeline',</span><br><span class="line">    'onMenuShareAppMessage',</span><br><span class="line">    //......</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>3.<code>网页授权</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">oauth</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'user'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>])) &#123;<span class="comment">//获取到授权code</span></span><br><span class="line">           $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">            $appid = Yii::$app-&gt;params[<span class="string">'WeChat'</span>][<span class="string">'AppID'</span>];</span><br><span class="line">            $secret = Yii::$app-&gt;params[<span class="string">'WeChat'</span>][<span class="string">'AppSecret'</span>];</span><br><span class="line">            <span class="comment">//获取access_token和openid</span></span><br><span class="line">            $url = <span class="string">"https://api.weixin.qq.com/sns/oauth2/access_token?appid=$appid&amp;secret=$secret&amp;code=$code&amp;grant_type=authorization_code"</span>;</span><br><span class="line">            $getTokenJson = file_get_contents($url);</span><br><span class="line">            $getTokenArray = json_decode($getTokenJson, <span class="keyword">true</span>);</span><br><span class="line">            $openId = $getTokenArray[<span class="string">'openid'</span>];</span><br><span class="line">            $accessToken = $getTokenArray[<span class="string">'access_token'</span>];</span><br><span class="line">            <span class="comment">//查询本地数据库判断用户是否存在</span></span><br><span class="line">            $user = UserService::getUserByOpenId($openId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//请求微信接口获取用户信息</span></span><br><span class="line">            $url = <span class="string">"https://api.weixin.qq.com/sns/userinfo?access_token=$accessToken&amp;openid=$openId&amp;lang=zh_CN"</span>;</span><br><span class="line">            $getTokenUser = file_get_contents($url);</span><br><span class="line">            $getTokenUser = json_decode($getTokenUser, <span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//包括openid,nickname,sex,province,city,country,headimgurl</span></span><br><span class="line">            $data = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">"subscribe"</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="string">"name"</span> =&gt; $getTokenUser[<span class="string">"nickname"</span>],</span><br><span class="line">                <span class="string">"openid"</span> =&gt; $getTokenUser[<span class="string">"openid"</span>],</span><br><span class="line">                <span class="string">"headimgurl"</span> =&gt; $getTokenUser[<span class="string">"headimgurl"</span>],</span><br><span class="line">                <span class="string">"sex"</span> =&gt; $getTokenUser[<span class="string">"sex"</span>],</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//用户存在则更新最新信息</span></span><br><span class="line">            <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">                $user_id = $user[<span class="string">'id'</span>];</span><br><span class="line">                UserService::udateUser($data, $user_id);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $user_id = UserService::addUser($data);</span><br><span class="line">            &#125;</span><br><span class="line">            $_SESSION[<span class="string">'user'</span>] = UserService::getUserByUserId($user_id);     </span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//请求oauth2授权</span></span><br><span class="line">            $callback = urlencode(<span class="string">"http://"</span> . $_SERVER[<span class="string">'HTTP_HOST'</span>] . strip_tags($_SERVER[<span class="string">'REQUEST_URI'</span>]));</span><br><span class="line">            $state = <span class="string">''</span>;</span><br><span class="line">            $url = <span class="string">"https://open.weixin.qq.com/connect/oauth2/authorize?appid=$appid&amp;redirect_uri=$callback&amp;response_type=code&amp;scope=snsapi_base&amp;state=$state#wechat_redirect"</span>;</span><br><span class="line">            header(<span class="string">"Location: $url"</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $_SESSION[<span class="string">'user'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.<code>服务器配置</code><br>这里可以用到微信公众平台<a href="https://github.com/dodgepudding/wechat-php-sdk/blob/master/wechat.class.php" target="_blank" rel="external">PHP-SDK</a>中的<code>wechat.class.php</code>库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Weixin</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $weObj;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $revData;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $revFrom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $config = Yii::$app-&gt;params[<span class="string">'WeChat'</span>];</span><br><span class="line">        $options = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'token'</span> =&gt; $config[<span class="string">"Token"</span>], <span class="comment">//填写你设定的key</span></span><br><span class="line">            <span class="string">'encodingaeskey'</span> =&gt; $config[<span class="string">"EncodingAESKey"</span>], <span class="comment">//填写加密用的EncodingAESKey</span></span><br><span class="line">            <span class="string">'appid'</span> =&gt; $config[<span class="string">"AppID"</span>], <span class="comment">//填写高级调用功能的app id</span></span><br><span class="line">            <span class="string">'appsecret'</span> =&gt; $config[<span class="string">"AppSecret"</span>], <span class="comment">//填写高级调用功能的密钥</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//wechat.class.php库</span></span><br><span class="line">        <span class="keyword">self</span>::$weObj = <span class="keyword">new</span> Wechat($options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($_GET) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$weObj-&gt;valid();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">self</span>::$weObj-&gt;valid(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'no access!!!'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $type = <span class="keyword">self</span>::$weObj-&gt;getRev()-&gt;getRevType();</span><br><span class="line">        <span class="keyword">self</span>::$revData = <span class="keyword">self</span>::$weObj-&gt;getRevData();</span><br><span class="line">        <span class="keyword">self</span>::$revFrom = <span class="keyword">self</span>::$weObj-&gt;getRevFrom();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;check($type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($type)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($type) &#123;</span><br><span class="line">            <span class="keyword">case</span> Wechat::MSGTYPE_TEXT:</span><br><span class="line">	            <span class="comment">//text</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;checkKeywords(<span class="keyword">self</span>::$weObj-&gt;getRev()-&gt;getRevContent());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Wechat::MSGTYPE_EVENT:</span><br><span class="line">	            <span class="comment">//event</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;checkEvents(<span class="keyword">self</span>::$revData[<span class="string">'Event'</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Wechat::MSGTYPE_IMAGE:</span><br><span class="line">	            <span class="comment">//image</span></span><br><span class="line">                <span class="keyword">self</span>::$weObj-&gt;text(<span class="string">'本系统暂不支持图片信息！'</span>)-&gt;reply();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">self</span>::$weObj-&gt;text(<span class="string">'本系统暂时无法识别您的指令！'</span>)-&gt;reply();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检测事件（只列举了3种）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkEvents</span><span class="params">($event)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $openid = <span class="keyword">self</span>::$revData[<span class="string">'FromUserName'</span>];</span><br><span class="line">        <span class="keyword">switch</span> ($event) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'subscribe'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;checkKeyWords(<span class="string">'subscribe'</span>);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;checkWechatUser($openid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'unsubscribe'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;updateUser($openid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'CLICK'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;checkKeyWords(<span class="keyword">self</span>::$revData[<span class="string">'EventKey'</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkWechatUser</span><span class="params">($openId)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $model = <span class="keyword">new</span> User();</span><br><span class="line">        $user = $model-&gt;findOne([<span class="string">'openid'</span> =&gt; $openId]);</span><br><span class="line">        $userInfo = <span class="keyword">self</span>::$weObj-&gt;getUserInfo($openId);</span><br><span class="line">        <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">            $model-&gt;updateAll(<span class="keyword">array</span>(<span class="string">"subscribe"</span> =&gt; <span class="number">1</span>, <span class="string">"username"</span> =&gt; $userInfo[<span class="string">"nickname"</span>]), <span class="keyword">array</span>(<span class="string">"id"</span> =&gt; $user[<span class="string">"id"</span>]));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $data = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">"subscribe"</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="string">"username"</span> =&gt; $userInfo[<span class="string">"nickname"</span>],</span><br><span class="line">                <span class="string">"openid"</span> =&gt; $userInfo[<span class="string">"openid"</span>],</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> ($model-&gt;load([$model-&gt;formName() =&gt; $data]) &amp;&amp; $model-&gt;validate()) &#123;</span><br><span class="line">                $model-&gt;save();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateUser</span><span class="params">($openId)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $model = <span class="keyword">new</span> User();</span><br><span class="line">        $user = $model-&gt;findOne([<span class="string">'openid'</span> =&gt; $openId]);</span><br><span class="line">        <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">            $model-&gt;updateAll(<span class="keyword">array</span>(<span class="string">"subscribe"</span> =&gt; <span class="number">0</span>), <span class="keyword">array</span>(<span class="string">"id"</span> =&gt; $user[<span class="string">"id"</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检测关键字自动回复</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkKeyWords</span><span class="params">($key)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $key = $key ? $key : <span class="keyword">self</span>::$weObj-&gt;getRev()-&gt;getRevContent();</span><br><span class="line">        $replay = WxMessage::getReply($key);</span><br><span class="line">        <span class="keyword">if</span> ($replay) &#123;</span><br><span class="line">	        <span class="comment">//图文消息</span></span><br><span class="line">            <span class="keyword">if</span> ($replay[<span class="number">0</span>][<span class="string">"type"</span>] == <span class="string">"news"</span>) &#123;</span><br><span class="line">                $newsArr = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">foreach</span> ($replay <span class="keyword">as</span> $value) &#123;</span><br><span class="line">                    $newsArr [] = <span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">'Title'</span> =&gt; $value[<span class="string">"title"</span>],</span><br><span class="line">                        <span class="string">'Description'</span> =&gt; $value[<span class="string">"description"</span>],</span><br><span class="line">                        <span class="string">'PicUrl'</span> =&gt; $value[<span class="string">"image"</span>],</span><br><span class="line">                        <span class="string">'Url'</span> =&gt; $value[<span class="string">"url"</span>]</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">self</span>::$weObj-&gt;news($newsArr)-&gt;reply();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//文字信息</span></span><br><span class="line">                <span class="keyword">self</span>::$weObj-&gt;text($replay[<span class="number">0</span>][<span class="string">"title"</span>])-&gt;reply();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>::$weObj-&gt;text(<span class="string">"亲，我们的系统暂时无法识别您的指令哦"</span>)-&gt;reply();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//生成微信菜单</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionMenu</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $menu = WxMenu::getTopMenu();</span><br><span class="line"></span><br><span class="line">        $newmenu[<span class="string">"button"</span>] = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($menu); $i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($menu[$i][<span class="string">"type"</span>] == <span class="string">"view"</span>) &#123;</span><br><span class="line">                $sub = WxMenu::getSubMenu($menu[$i][<span class="string">"id"</span>]);</span><br><span class="line">                <span class="keyword">if</span> ($sub) &#123;</span><br><span class="line">                    $sub_button = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; count($sub); $j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ($sub[$j][<span class="string">"type"</span>] == <span class="string">"view"</span>) &#123;</span><br><span class="line">                            array_push($sub_button, <span class="keyword">array</span>(<span class="string">'type'</span> =&gt; <span class="string">'view'</span>, <span class="string">'name'</span> =&gt; $sub[$j][<span class="string">"name"</span>], <span class="string">'url'</span> =&gt; $sub[$j][<span class="string">"url"</span>]));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            array_push($sub_button, <span class="keyword">array</span>(<span class="string">'type'</span> =&gt; <span class="string">'click'</span>, <span class="string">'name'</span> =&gt; $sub[$j][<span class="string">"name"</span>], <span class="string">'key'</span> =&gt; $sub[$j][<span class="string">"key"</span>]));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    array_push($newmenu[<span class="string">"button"</span>], <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; $menu[$i][<span class="string">"name"</span>], <span class="string">'sub_button'</span> =&gt; $sub_button));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    array_push($newmenu[<span class="string">"button"</span>], <span class="keyword">array</span>(<span class="string">'type'</span> =&gt; <span class="string">'view'</span>, <span class="string">'name'</span> =&gt; $menu[$i][<span class="string">"name"</span>], <span class="string">'url'</span> =&gt; $menu[$i][<span class="string">"url"</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $sub = WxMenu::getSubMenu($menu[$i][<span class="string">"id"</span>]);</span><br><span class="line">                <span class="keyword">if</span> ($sub) &#123;</span><br><span class="line">                    $sub_button = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; count($sub); $j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ($sub[$j][<span class="string">"type"</span>] == <span class="string">"view"</span>) &#123;</span><br><span class="line">                            array_push($sub_button, <span class="keyword">array</span>(<span class="string">'type'</span> =&gt; <span class="string">'view'</span>, <span class="string">'name'</span> =&gt; $sub[$j][<span class="string">"name"</span>], <span class="string">'url'</span> =&gt; $sub[$j][<span class="string">"url"</span>]));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            array_push($sub_button, <span class="keyword">array</span>(<span class="string">'type'</span> =&gt; <span class="string">'click'</span>, <span class="string">'name'</span> =&gt; $sub[$j][<span class="string">"name"</span>], <span class="string">'key'</span> =&gt; $sub[$j][<span class="string">"key"</span>]));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    array_push($newmenu[<span class="string">"button"</span>], <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; $menu[$i][<span class="string">"name"</span>], <span class="string">'sub_button'</span> =&gt; $sub_button));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    array_push($newmenu[<span class="string">"button"</span>], <span class="keyword">array</span>(<span class="string">'type'</span> =&gt; <span class="string">'click'</span>, <span class="string">'name'</span> =&gt; $menu[$i][<span class="string">"name"</span>], <span class="string">'key'</span> =&gt; $menu[$i][<span class="string">"key"</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $json = <span class="keyword">self</span>::$weObj-&gt;createMenu($newmenu);</span><br><span class="line">        $json = json_decode($json, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($json[<span class="string">"errcode"</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">            $result = [<span class="string">"code"</span> =&gt; <span class="number">0</span>, <span class="string">"message"</span> =&gt; <span class="string">'success'</span>, <span class="string">"object"</span> =&gt; <span class="keyword">null</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $result = [<span class="string">"code"</span> =&gt; <span class="number">1</span>, <span class="string">"message"</span> =&gt; <span class="string">'fail'</span>, <span class="string">"object"</span> =&gt; $json];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json_encode($result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以用的2张表<br><code>菜单表</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">type</th>
<th style="text-align:left">name</th>
<th style="text-align:left">key</th>
<th style="text-align:left">url</th>
<th style="text-align:left">pid</th>
<th style="text-align:left">order</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">view</td>
<td style="text-align:left">菜单一</td>
<td style="text-align:left"></td>
<td style="text-align:left"><a href="http://m.baidu.com" target="_blank" rel="external">http://m.baidu.com</a></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">view</td>
<td style="text-align:left">菜单二</td>
<td style="text-align:left">key</td>
<td style="text-align:left"><a href="http://m.baidu.com" target="_blank" rel="external">http://m.baidu.com</a></td>
<td style="text-align:left">0</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">click</td>
<td style="text-align:left">菜单三</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">view</td>
<td style="text-align:left">子菜单</td>
<td style="text-align:left"></td>
<td style="text-align:left"><a href="http://m.baidu.com" target="_blank" rel="external">http://m.baidu.com</a></td>
<td style="text-align:left">3</td>
<td style="text-align:left">1</td>
</tr>
</tbody>
</table>
<p><code>关键字回复表</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">type</th>
<th style="text-align:left">title</th>
<th style="text-align:left">description</th>
<th style="text-align:left">url</th>
<th style="text-align:left">image</th>
<th style="text-align:left">key</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">news</td>
<td style="text-align:left">菜单三的回复</td>
<td style="text-align:left">描述</td>
<td style="text-align:left"><a href="http://m.baidu.com" target="_blank" rel="external">http://m.baidu.com</a></td>
<td style="text-align:left">1.jpg</td>
<td style="text-align:left">key</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">news</td>
<td style="text-align:left">欢迎关注</td>
<td style="text-align:left">描述</td>
<td style="text-align:left"><a href="http://m.baidu.com" target="_blank" rel="external">http://m.baidu.com</a></td>
<td style="text-align:left">2.jpg</td>
<td style="text-align:left">subscribe</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">text</td>
<td style="text-align:left">测试</td>
<td style="text-align:left"></td>
<td style="text-align:left"><a href="http://m.baidu.com" target="_blank" rel="external">http://m.baidu.com</a></td>
<td style="text-align:left"></td>
<td style="text-align:left">测试</td>
</tr>
</tbody>
</table>
<p>可以看到菜单3是click按钮，点击菜单3（key）会回复一个图文消息<br>关注事件也会回复一个图文消息<br>给公众号发<code>测试</code>会回复一条文字消息</p>
<p>大致就这些了，如有错误欢迎指正</p>
<p>具体可参考<a href="http://mp.weixin.qq.com/wiki/home/index.html" target="_blank" rel="external">微信开发者文档</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/11/04/微信开发常用接口的PHP封装/" data-id="ciwc4lj5x000jgo7zs7gk2vbg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信/">微信</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-php合成图片加水印" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/27/php合成图片加水印/" class="article-date">
  <time datetime="2016-10-27T14:40:14.000Z" itemprop="datePublished">2016-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/27/php合成图片加水印/">php合成图片加水印</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>分享自己写的一个php的图像处理的一些方法，包括图片的缩小和放大，两张图的合成，和图片写入文字</p>
<p>这里实现的是一个底图和一个二维码合成并加上水印的功能，其中二维码可以自定义缩放比例</p>
<p>先是生成一个底图画布，然后生成相关大小的二维码图片的临时文件，然后将两张图合成，最后在画布上写入文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="comment">/**</span><br><span class="line"> * author lkj</span><br><span class="line"> * date 2015/12/26</span><br><span class="line"> * <span class="doctag">@param</span> string $img 底图路径</span><br><span class="line"> * <span class="doctag">@param</span> string $qrcode 二维码路径</span><br><span class="line"> * <span class="doctag">@param</span> int $x 二维码左边距 true水平居中</span><br><span class="line"> * <span class="doctag">@param</span> int $y 二维码上边距 true垂直居中</span><br><span class="line"> * <span class="doctag">@param</span> int $percent 二维码按比例缩放</span><br><span class="line"> * <span class="doctag">@param</span> bool $save false直接输出true保存文件</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">bool imagecopy ( resource $dst_im , resource $src_im , int $dst_x , int $dst_y , int $src_x , int $src_y , int $src_w , int $src_h )</span><br><span class="line">将 src_im 图像中坐标从 src_x，src_y 开始，宽度为 src_w，高度为 src_h 的一部分拷贝到 dst_im 图像中坐标为 dst_x 和 dst_y 的位置上。</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergerImg</span><span class="params">($img, $qrcode, $x, $y, $percent, $save = false)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/***底图处理****/</span></span><br><span class="line">    <span class="keyword">list</span>($max_width, $max_height) = getimagesize($img);</span><br><span class="line">    $dests = imagecreatetruecolor($max_width, $max_height);</span><br><span class="line">    $dst_im = imagecreatefromjpeg($img);</span><br><span class="line">    imagecopy($dests, $dst_im, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, $max_width, $max_height);</span><br><span class="line">    imagedestroy($dst_im);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*********二维码大小调整并保存********** */</span></span><br><span class="line">    <span class="comment">// Get new sizes</span></span><br><span class="line">    <span class="keyword">list</span>($width, $height) = getimagesize($qrcode);</span><br><span class="line"></span><br><span class="line">    $newwidth = $width * $percent;</span><br><span class="line">    $newheight = $height * $percent;</span><br><span class="line">    <span class="comment">// Load</span></span><br><span class="line">    $thumb = imagecreatetruecolor($newwidth, $newheight);</span><br><span class="line">    $source = imagecreatefrompng($qrcode);</span><br><span class="line">    <span class="comment">// Resize</span></span><br><span class="line">    imagecopyresized($thumb, $source, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, $newwidth, $newheight, $width, $height);</span><br><span class="line">    $name = <span class="string">'tmep.png'</span>;<span class="comment">//缩放二维码存放临时文件</span></span><br><span class="line">    <span class="comment">// Save</span></span><br><span class="line">    imagepng($thumb, $name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*******图片合成*********/</span></span><br><span class="line">    $src_im = imagecreatefrompng($name);</span><br><span class="line">    $src_info = getimagesize($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($x === <span class="keyword">true</span>) &#123;<span class="comment">//水平居中</span></span><br><span class="line">        $padding_left = ($max_width - $src_info[<span class="number">0</span>]) / <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $padding_left = $x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($y === <span class="keyword">true</span>) &#123;<span class="comment">//垂直居中</span></span><br><span class="line">        $padding_top = ($max_height - $src_info[<span class="number">1</span>]) / <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $padding_top = $y;</span><br><span class="line">    &#125;</span><br><span class="line">    imagecopy($dests, $src_im, $padding_left, $padding_top, <span class="number">0</span>, <span class="number">0</span>, $src_info[<span class="number">0</span>], $src_info[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*******写入文字******/</span></span><br><span class="line">    $color = imagecolorallocate($dests, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>); <span class="comment">//字体颜色</span></span><br><span class="line">    $fontfile = <span class="string">"font.ttf"</span>; <span class="comment">//字体文件</span></span><br><span class="line">    $string = <span class="string">"@likangjun.com"</span>;</span><br><span class="line">    imagettftext($dests, <span class="number">18</span>, <span class="number">0</span>, <span class="number">230</span>, <span class="number">760</span>, $color, $fontfile, $string);</span><br><span class="line">    unlink($name);<span class="comment">//删除临时文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*******保存文件********/</span></span><br><span class="line">    <span class="keyword">if</span> ($save) &#123;</span><br><span class="line">        $savepath = <span class="string">"qrcode.png"</span>;</span><br><span class="line">        $result = imagepng($dests, $savepath);</span><br><span class="line">        imagedestroy($dests);</span><br><span class="line">        <span class="keyword">echo</span> $result ? <span class="string">'success'</span> : <span class="string">'fail'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*******输出到浏览器********/</span></span><br><span class="line">    header(<span class="string">'Content-Type: image/jpeg'</span>);</span><br><span class="line">    imagepng($dests);</span><br><span class="line">    imagedestroy($dests);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关的小项目可以看githu和demo更加的直观<br>demo用get自定义二维码内容和水印内容，不妨点击去试试~<br>github的地址是：<a href="https://github.com/likangjun/image" target="_blank" rel="external">https://github.com/likangjun/image</a><br>demo: <a href="http://demo.likangjun.com/image/index.php?qrcode=http://likangjun.com&amp;water=likangjun.com" target="_blank" rel="external">http://demo.likangjun.com/image/index.php?qrcode=http://likangjun.com&amp;water=likangjun.com</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://likangjun.com/2016/10/27/php合成图片加水印/" data-id="ciwc4lj5v000hgo7zt6tjxmcr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/图片合成/">图片合成</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/水印/">水印</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/ajax/" style="font-size: 10px;">ajax</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/php/" style="font-size: 20px;">php</a> <a href="/tags/redis/" style="font-size: 13.33px;">redis</a> <a href="/tags/即时聊天/" style="font-size: 10px;">即时聊天</a> <a href="/tags/图片合成/" style="font-size: 10px;">图片合成</a> <a href="/tags/并发/" style="font-size: 13.33px;">并发</a> <a href="/tags/微信/" style="font-size: 10px;">微信</a> <a href="/tags/支付/" style="font-size: 10px;">支付</a> <a href="/tags/水印/" style="font-size: 10px;">水印</a> <a href="/tags/递归/" style="font-size: 16.67px;">递归</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/05/Redis-消息队列和异步处理/">Redis-消息队列和异步处理</a>
          </li>
        
          <li>
            <a href="/2016/11/25/Redis用法和总结/">Redis用法和总结</a>
          </li>
        
          <li>
            <a href="/2016/11/17/mysql行级锁处理小规模并发实现抢购秒杀/">mysql行级锁处理小规模并发实现抢购秒杀</a>
          </li>
        
          <li>
            <a href="/2016/11/15/php 关于支付宝手机网站支付/">php 关于支付宝手机网站支付(alipay.wap.create.direct.pay.by.user)</a>
          </li>
        
          <li>
            <a href="/2016/11/15/php 递归函数的应用(三) 层级结构数据的树状输出/">PHP 递归函数的应用(三)  层级结构数据的树状输出</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Likangjun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      
      <!-- Analytics -->
      <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260672741' style='margin-left: 10px'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1260672741%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
      <!-- End Analytics -->
      
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/atom.xml" class="mobile-nav-link">Rss</a>
  
    <a href="/sitemap.xml" class="mobile-nav-link">Sitemap</a>
  
</nav>
    

<script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>